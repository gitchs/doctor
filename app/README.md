# README

## WHY

1. 查询变慢，极度影响客户效率，很容易导致客户抱怨；原因有很多
   1. 随着使用深入，系统压力变大
      - 使用人数变多，查询的指标变多，算力要求增加；
      - 客户业务增长引起的数据量变化；
      - 数据积累变多，同样的配置，查询压力变大（比如查询时间配置了“上线以来”，几年后查询跑不出来是正常现象）
   2. 缺乏治理，系统墒增
      - 实际废弃的概览、分群例行任务；
   3. 资源问题
      * 系统故障，比如HDFS出现抖动，IO速度跌破预期；
      * 临时任务挤占资源，比如客户近期集中删除数据，占用YARN资源；
   4. 不符合最佳实践
      * 存在大量零碎文件；
      * 集群机器配置不统一；
      * 使用了swap；
      * 集群存在硬件故障机器；
      * 压力调度不均匀；
   5. 数据倾斜严重
      * 比如某客户，小几十台机器，10亿数据，hash join的时候9亿发到了一台机器上；
   6. 潜在的bug
      * 内存泄漏



----

## 目标

1. 在大部分时候让SA标准功能，可以在合理的时间执行完；
2. 不保证质量的情况：自定义查询、JDBC等提交的查询，自由度过高，开口问题没有答案；

## HOW TO

通过两个方面进行量化评估

1. 单个查询内，算子执行速度是否均匀：计算任务的压力是平均分配的，但是各种各样的问题可能造成各实例的算子执行速度不统一
   1. 实力上某组件故障，需要从别的节点上访问数据；
   2. 机器老化或有特殊配置，成为算力短板；
   3. 实际压力不平均：比如零碎文件跟大文件混杂，虽然处理的文件数基本一致（压力平均分配），但BytesRead相差非常多（实际压力有倾斜）；
   4. 一些特殊优化造成的倾斜（倾斜是正常的）；
2. 查询横向对比
   1. 算子的benchmark是否在平均水平上？即使算子不存在倾斜的状况，如果组件的状况不符合预期，可能会造成算子的benchmark远低于预期（比如HDFS的零碎文件非常多，Scanner的吞吐速度降低到600k/s，而正常的水平在100+M/s）;

### 如何度量算子的倾斜

#### Naive Method

1. 基于统计，要求impalad示例数>=3，否则没有统计的意义；
2. 统计术语
   * mean: 平均值
   * std: 方差，不做特殊说明的情况下，ddof=0
   * max: 极大值
   * min：极小值
   * range = max - min
3. 异常点判断
   * 极快：TotalTime < mean - 2 * std；多实例的情况下，需要关注”极快“的点是否会造成极慢的点（资源竞争，导致一个host上两个实例执行速度两集分化）
   * 极慢：TotalTime > mean + 2 * std
4. 以下情况，认为是合理的倾斜
   * 开启了shuffle merge机制，造成的倾斜：shuffle merge需要对数据进行排序，数据不一样，实际的排序速度会有一些出入；

### 如何衡量算子的速度是否合理

1. 分组统计不同负载下，算子的执行速度，得出环境的经验值；
2. 将当前算子的速度，跟经验值进行比对；



 #### 实操问题

1. 高负载的情况下，算子的性能会下降，目前度不清楚；
2. 同样的算子，不同的执行压力，能到达的速度上线是不一样的；



## HOOKS

1. 扩容流程，查询问题可以加入自动化诊断流程，结果由查询的运维同事进行复核；
1. 异常查询较多的区间，需要人工定位原因后，若最后的技术归因可以自动化，检查到响应case的时候可以执行自动诊断；